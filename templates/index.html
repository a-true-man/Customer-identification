{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="header">
    <h1>××¢×¨×›×ª ×œ×§×•×—×•×ª</h1>
    <div class="header-buttons">
      <a href="/add" class="btn">â• ×”×•×¡×£ ×œ×§×•×—</a>
      <a href="/clients" class="btn">ğŸ“‹ ×›×œ ×”×œ×§×•×—×•×ª</a>
    </div>
  </div>
    <div class="card2">
      <div>×¤×× ×œ ×©×œ×™×˜×”</div>
        <div class="card3">
          <a href="/add" class="refrash">â¹</a>
          <a href="/settings" class="refrash">â¹</a>
        </div>
    </div>

  <div class="split-view">
    <!-- ×œ×§×•×—×•×ª ××—×¨×•× ×™× -->
    <div class="sidebar" id="recentList">
      <h3>×”×™×¡×˜×•×¨×™×”</h3>
      <!-- ×™×ª××œ× ×‘-JS -->
    </div>

    <!-- ×©×™×—×•×ª × ×•×›×—×™×•×ª -->
    <div class="main" id="currentList">
      <h3>×©×™×—×•×ª × ×›× ×¡×•×ª</h3>
      <!-- ×™×ª××œ× ×‘-JS -->
    </div>
  </div>
</div>

<script>
  // ×¤×•× ×§×¦×™×” ×œ×”×¢×ª×§×ª ×˜×§×¡×˜ ×œ×œ×•×—
  function copy(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('×”××¡×¤×¨ ×”×•×¢×ª×§: ' + text);
    });
  }

  // × ×™×•×•×˜ ×œ×¢×¨×™×›×”/×”×•×¡×¤×”
  function goToEdit(phone) {
    window.location.href = '/add?phone=' + encodeURIComponent(phone);
  }

  async function fetchLists() {
    // ×©×™×—×•×ª × ×•×›×—×™×•×ª
    let currRes = await fetch('/api/current_clients');
    let current = currRes.ok ? await currRes.json() : [];
    const currentDiv = document.getElementById('currentList');
    if (current.length > 0) {
      currentDiv.innerHTML = '<h3>×©×™×—×•×ª × ×›× ×¡×•×ª</h3>' + current.map(c => `
        <div class="card">
          <h4>×©×: ${c.name || '×œ× ××–×•×”×”'}</h4>
          <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${c.phone}</p>
          <p><strong>×¡×˜×˜×•×¡:</strong> ${c.status || '-'}</p>
          <p><strong>×”×¢×¨×•×ª:</strong> ${c.notes}</p>
          <div class="actions">
            <a onclick="copy('${c.phone}')" class="btn" title="×”×¢×ª×§ ××¡×¤×¨">ğŸ“‹</a>
                      ${c.name
              ? `<a href="/edit/${c.phone}" class="btn" title="×¢×¨×•×š ×œ×§×•×—">âœï¸</a>`
            : `<a href="#" onclick="goToEdit('${c.phone}')" class="btn" title="×”×•×¡×£ ×œ×§×•×—">ğŸ“</a>`}
          </div>
        </div>`).join('');
    } else {
      currentDiv.innerHTML = '<p class="loading-dots">×××ª×™×Ÿ ×œ×©×™×—×”<span>.</span><span>.</span><span>.</span></p>';
    }

    // ×œ×§×•×—×•×ª ××—×¨×•× ×™× ×¢× ×›×¤×ª×•×¨ ××•×ª× ×”
    let recRes = await fetch('/api/recent_clients');
    let recent = recRes.ok ? await recRes.json() : [];
    const recentDiv = document.getElementById('recentList');
    if (recent.length > 0) {
      // × ×™×ª×Ÿ ×œ×”×•×¡×™×£  '<h3>×”×™×¡×˜×•×¨×™×ª ×©×™×—×•×ª</h3>' + ×œ×¤× ×™ ×” recent.map
      recentDiv.innerHTML = recent.map(c => `
        <div class="card">
          <span>${c.name || '×œ× ××–×•×”×”'}</span>
          <p>${c.phone}</p>
          <div class="actions">
            <a onclick="copy('${c.phone}')" class="btn" title="×—×™×™×’">â˜ï¸</a>
            ${c.name
              ? `<a href="/edit/${c.phone}" class="btn" title="×¢×¨×•×š ×œ×§×•×—">âœï¸</a>`
            : `<a href="#" onclick="goToEdit('${c.phone}')" class="btn" title="×”×•×¡×£ ×œ×§×•×—">ğŸ“</a>`}
          </div>
        </div>`).join('');
    } else {
      recentDiv.innerHTML = '<p>××™×Ÿ ×©×™×—×•×ª ××—×¨×•× ×•×ª</p>';
    }
  }

  setInterval(fetchLists, 2000);
  fetchLists();
</script>
{% endblock %}
